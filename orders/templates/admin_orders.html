<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionar Pedidos</title>
</head>

<body>
    {% extends 'base.html' %}
    {% block content %}
    <h1 class="text-center">Gestión de Pedidos</h1>

    {% if messages %}
    <div class="alert-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="GET" action="{% url 'manage_orders' %}" class="mb-4 d-flex">
        <input type="text" name="client" class="form-control me-2" placeholder="Buscar por cliente"
            value="{{ client_query }}">
        <input type="date" name="date" class="form-control me-2" value="{{ date_query }}">
        <button type="submit" class="btn btn-primary">Buscar</button>
    </form>

    {% if page_obj %}
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>N° Pedido</th>
                <th>Cliente</th>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for order in page_obj.object_list %}
            {% for detail in order.order_details.all %}
            <tr>
                <td>{{ order.id }}</td>
                <td>{{ order.client.first_name }} {{ order.client.last_name }}</td>
                <td>{{ detail.product.description }}</td>
                <td>{{ detail.quantity }}</td>
                <td>${{ detail.product.price }}</td>
                <td>{{ order.date_order }}</td>
                <td>{{ order.get_status_display }}</td>
                <td>
                    {% if order.status == 'Confirmed' %}
                    <a href="{% url 'dispatch_order' order.id %}" class="btn btn-primary btn-sm"
                        onclick="return confirm('¿Está seguro de despachar este pedido?');">
                        <i class="bi bi-truck"></i>Despachar
                    </a>
                    {% elif order.status == 'Dispatched' %}
                    No disponible
                    {% else %}
                    No disponible
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% endfor %}
        </tbody>
    </table>

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1">&laquo;&laquo;</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">&laquo;</a></li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active"><a class="page-link">{{ num }}</a></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <li class="page-item"><a
                    class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">&raquo;</a></li>
                <li class="page-item"><a class="page-link"
                        href="?page={{ page_obj.paginator.num_pages }}">&raquo;&raquo;</a></li>
                {% endif %}
        </ul>
    </nav>

    {% else %}
    <p>No hay pedidos realizados.</p>
    {% endif %}

    {% endblock %}
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Pedidos</title>
</head>

<body>
    {% extends 'base.html' %}
    {% block content %}
    <h1 class="text-center">Mis Pedidos</h1>

    {% if messages %}
    <div class="alert-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="GET" action="{% url 'client_orders' %}" class="mb-4 d-flex">
        <input type="date" name="date" class="form-control me-2" value="{{ date_query }}">
        <button type="submit" class="btn btn-primary">Buscar</button>
    </form>

    {% if page_obj %}
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>

                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio</th>
                <th>Fecha</th>
                <th>Estado</th>
                <th>Tiempo Restante</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for order in page_obj.object_list %}
            {% for detail in order.order_details.all %}
            <tr data-order-id="{{ order.id }}" data-remaining-time="{{ order.remaining_time }}"
                data-order-status="{{ order.status }}">

                <td>{{ detail.product.description }}</td>
                <td>{{ detail.quantity }}</td>
                <td>${{ detail.product.price }}</td>
                <td>{{ order.date_order }}</td>
                <td>{{ order.get_status_display }}</td>
                <td id="timer-{{ order.id }}">--:--</td>
                <td>
                    {% if order.is_cancelable %}
                    <a href="{% url 'cancel_order' order.id %}" id="cancel-btn-{{ order.id }}"
                        class="btn btn-danger btn-sm"
                        onclick="return confirm('¿Seguro que deseas cancelar este pedido?');">
                        <i class="bi bi-ban"></i> Cancelar
                    </a>
                    <a href="{% url 'confirm_order' order.id %}" id="confirm-btn-{{ order.id }}"
                        class="btn btn-success btn-sm"
                        onclick="return confirm('¿Seguro que deseas confirmar este pedido?');">
                        <i class="bi bi-check-circle"></i> Confirmar
                    </a>
                    {% else %}
                    No disponible
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% endfor %}

        </tbody>
    </table>

    <div class="text-end mt-4">
        <h4>Total: ${{ grand_total }}</h4>
    </div>

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1">&laquo;&laquo;</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">&laquo;</a></li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active"><a class="page-link">{{ num }}</a></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <li class="page-item"><a
                    class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">&raquo;</a></li>
                <li class="page-item"><a class="page-link"
                        href="?page={{ page_obj.paginator.num_pages }}">&raquo;&raquo;</a></li>
                {% endif %}
        </ul>
    </nav>

    {% else %}
    <p>No tienes pedidos realizados.</p>
    {% endif %}

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll("[data-order-id]").forEach(function (orderElement) {
                let orderId = orderElement.getAttribute("data-order-id");
                let remainingTime = parseInt(orderElement.getAttribute("data-remaining-time"), 10) || 0;
                let orderStatus = orderElement.getAttribute("data-order-status"); // Obtener estado del pedido
                let cancelButton = document.getElementById(`cancel-btn-${orderId}`);
                let confirmButton = document.getElementById(`confirm-btn-${orderId}`);
                let timerDisplay = document.getElementById(`timer-${orderId}`);

                // Si el pedido ya está confirmado, detener el temporizador y ocultar botones
                if (orderStatus === "Confirmed") {
                    timerDisplay.textContent = "--:--";
                    cancelButton.style.display = "none";
                    confirmButton.style.display = "none";
                    return; // No iniciar el temporizador
                }

                function updateTimer() {
                    if (remainingTime > 0) {
                        let minutes = Math.floor(remainingTime / 60);
                        let seconds = remainingTime % 60;
                        timerDisplay.textContent = `Tiempo restante: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                        remainingTime--;
                    } else {
                        cancelButton.disabled = true;
                        confirmButton.disabled = true;
                        cancelButton.classList.add("disabled");
                        confirmButton.classList.add("disabled");
                        timerDisplay.textContent = "Tiempo expirado";

                        fetch(`/update-order-status/${orderId}/`, {
                            method: "POST",
                            headers: {
                                "X-CSRFToken": "{{ csrf_token }}",
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({})
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    location.reload();
                                }
                            });

                        clearInterval(timerInterval);
                    }
                }

                let timerInterval = setInterval(updateTimer, 1000);
                updateTimer();
            });
        });
    </script>

    {% endblock %}
</body>

</html>